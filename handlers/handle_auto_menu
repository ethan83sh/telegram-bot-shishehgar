from telegram import Update
from telegram.ext import ContextTypes

async def handle_auto_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    # init مقادیر
    if "auto_interval" not in context.bot_data:
        context.bot_data["auto_interval"] = 60
    if "auto_text" not in context.bot_data:
        context.bot_data["auto_text"] = "این پیام خودکار است."
    if "auto_job" not in context.bot_data:
        context.bot_data["auto_job"] = None
    if "auto_start_time" not in context.bot_data:
        context.bot_data["auto_start_time"] = None

    data = query.data

    if data == "view_interval":
        interval = context.bot_data["auto_interval"]
        await query.message.reply_text(f"بازه زمانی فعلی: {interval} دقیقه")
    elif data == "change_interval":
        context.user_data["awaiting_interval"] = True
        await query.message.reply_text("لطفاً بازه زمانی جدید (دقیقه) را ارسال کن")
    elif data == "view_text":
        text = context.bot_data["auto_text"]
        await query.message.reply_text(f"متن فعلی پیام:\n{text}")
    elif data == "change_text":
        context.user_data["awaiting_text"] = True
        await query.message.reply_text("لطفاً متن جدید پیام خودکار را ارسال کن")
    elif data == "reset_start":
        context.user_data["awaiting_reset"] = True
        await query.message.reply_text("لطفاً زمان شروع (مثال: 21:00) را وارد کن")
    elif data == "stop_auto":
        job = context.bot_data.get("auto_job")
        if job:
            job.schedule_removal()
            context.bot_data["auto_job"] = None
        await query.message.reply_text("ارسال پیام خودکار متوقف شد ✅")
